version: 2.1

defaults: &defaults
  working_directory: ~/tomwells.org
  docker:
    - image: cimg/node:15.11-browsers

jobs:
  build-and-deploy:
    <<: *defaults
    steps:
      - run:
          command: 
            >-
            git clone https://github.com/obmarg/libsysconfcpus \
            && cd libsysconfcpus && ./configure && make && sudo make install \
            && rm -rf libsysconfcpus
      # - run:
      #     command: sysconfcpus -n 2 cat /proc/cpuinfo
      # - run: 
      #     command: rm -rf libsysconfcpus
      # - run:
      #     command: sudo find / | grep libtinfo.so
      - run:
          name: Symlink libtinfo.so (pre-compiled purescript needs this)
          command: sudo ln -s /usr/lib/x86_64-linux-gnu/libtinfo.so.6 /usr/lib/x86_64-linux-gnu/libtinfo.so.5
      - checkout
      - run:
          command: npm install
      # - restore_cache:
      #     keys:
      #       - purescript-compile-deps-x{{ checksum "spago.dhall" }}-{{ checksum "packages.dhall" }}
      - run:
          command: sysconfcpus -n 2 npm run build
      # - save_cache:
      #     key: purescript-compile-deps-x{{ checksum "spago.dhall" }}-{{ checksum "packages.dhall" }}
      #     paths:
      #       - .spago
      #       - output
      - run: 
          command: npm run bundle
      - run:
          command: npm run deploy
workflows:
  build:
    jobs:
      - build-and-deploy
