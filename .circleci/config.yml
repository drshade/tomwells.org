version: 2.1
orbs:
  node: circleci/node@4.2.0
jobs:
  build-and-deploy:
    docker: 
      - image: cimg/node:12.5-browsers
    steps:
      # - run:
      #     command: git clone https://github.com/obmarg/libsysconfcpus
      # - run:
      #     command: cd libsysconfcpus && ./configure && make && sudo make install 
      # - run:
      #     command: sysconfcpus -n 2 cat /proc/cpuinfo
      # - run: 
      #     command: rm -rf libsysconfcpus
      - checkout
      - run:
          command: npm install
      # - restore_cache:
      #     keys:
      #       - purescript-compile-deps-x{{ checksum "spago.dhall" }}-{{ checksum "packages.dhall" }}
      - run:
          command: npm run build
          environment:
            RTS_ARGS: +RTS -N2 -RTS
      # - save_cache:
      #     key: purescript-compile-deps-x{{ checksum "spago.dhall" }}-{{ checksum "packages.dhall" }}
      #     paths:
      #       - .spago
      #       - output
      - run: 
          command: npm run bundle
      - run:
          command: npm run deploy
workflows:
  build:
    jobs:
      - build-and-deploy
